<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
    const shareDialog = document.getElementById("shareDialog");
    const closeModalBtn = document.querySelector(".close-modal");
    const cancelShareBtn = document.querySelector(".cancel-share");

    function closeShareDialog() {
        shareDialog.style.display = "none";
    }

    closeModalBtn.addEventListener("click", closeShareDialog);
    cancelShareBtn.addEventListener("click", closeShareDialog);
    // Th√™m h√†m showNotification
    function showNotification(message, type = 'success') {
        // X√≥a notification c≈© n·∫øu c√≥
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        
        // Style cho notification
        Object.assign(notification.style, {
            position: 'fixed',
            bottom: '20px',
            right: '20px',
            padding: '12px 24px',
            borderRadius: '8px',
            color: 'white',
            zIndex: '1001',
            animation: 'slideInRight 0.3s ease-in-out',
            backgroundColor: type === 'success' ? '#4BB543' : '#ff3333'
        });

        document.body.appendChild(notification);

        // T·ª± ƒë·ªông x√≥a notification sau 3 gi√¢y
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease-in-out';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    let currentPostIdForShare = null;

    // X·ª≠ l√Ω n√∫t Like
    document.querySelectorAll('.like-btn').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            const isLiked = this.getAttribute('data-liked') === 'true';
            const likeIcon = this.querySelector('.like-icon');
            const likeText = this.querySelector('.like-text');

            // Th√™m class animation
            likeIcon.classList.add('animating');
            
            fetch(`/posts/${postId}/like`, {
                method: 'POST',
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£t like
                const likeCountElement = document.querySelector(`.like-count[data-post-id="${postId}"]`);
                if (likeCountElement) {
                    likeCountElement.textContent = `üëç ${data.likeCount}`;
                }

                // Toggle tr·∫°ng th√°i like
                if (data.isLiked) {
                    this.classList.add('liked');
                    this.setAttribute('data-liked', 'true');
                    likeIcon.classList.remove('far');
                    likeIcon.classList.add('fas');
                } else {
                    this.classList.remove('liked');
                    this.setAttribute('data-liked', 'false');
                    likeIcon.classList.remove('fas');
                    likeIcon.classList.add('far');
                }

                // X√≥a class animation sau khi ho√†n th√†nh
                setTimeout(() => {
                    likeIcon.classList.remove('animating');
                }, 400);
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('C√≥ l·ªói x·∫£y ra khi th√≠ch b√†i vi·∫øt', 'error');
            });
        });
    });

    // X·ª≠ l√Ω n√∫t Comment
    document.querySelectorAll('.comment-btn').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            const commentSection = document.querySelector(`.comment-section[data-post-id="${postId}"]`);
            if (commentSection) {
                commentSection.style.display = commentSection.style.display === 'none' ? 'block' : 'none';
            }
        });
    });

    // X·ª≠ l√Ω n√∫t xem th√™m v√† ·∫©n b·ªõt comment
    document.querySelectorAll('.view-more-btn, .hide-comments-btn').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            const commentsSection = this.closest('.comments-list');
            const hiddenComments = commentsSection.querySelector('.hidden-comments');
            const viewMoreBtn = commentsSection.querySelector('.view-more-btn');
            const hideCommentsBtn = commentsSection.querySelector('.hide-comments-btn');

            if (this.classList.contains('view-more-btn')) {
                // Hi·ªÉn th·ªã comments ·∫©n
                hiddenComments.style.display = 'block';
                // ·∫®n n√∫t xem th√™m
                viewMoreBtn.style.display = 'none';
                // Hi·ªán n√∫t ·∫©n b·ªõt
                hideCommentsBtn.style.display = 'block';
            } else {
                // ·∫®n comments
                hiddenComments.style.display = 'none';
                // Hi·ªán n√∫t xem th√™m
                viewMoreBtn.style.display = 'block';
                // ·∫®n n√∫t ·∫©n b·ªõt
                hideCommentsBtn.style.display = 'none';
            }
        });
    });

    // X·ª≠ l√Ω submit comment
    document.querySelectorAll('.submit-comment').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            const input = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
            if (!input || !input.value.trim()) return;

            const formData = new URLSearchParams();
            formData.append('content', input.value.trim());

            fetch(`/posts/${postId}/comment`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData,
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng comment
                const commentCountElement = document.querySelector(`.comment-count[data-post-id="${postId}"]`);
                if (commentCountElement) {
                    commentCountElement.textContent = `üí¨ ${data.totalComments}`;
                }

                // Th√™m comment m·ªõi v√†o danh s√°ch
                const commentsList = document.querySelector(`.comments-list[data-post-id="${postId}"]`);
                if (commentsList) {
                    const initialComments = commentsList.querySelector('.initial-comments');
                    const hiddenComments = commentsList.querySelector('.hidden-comments');
                    
                    const newCommentHtml = `
                        <div class="comment-item" style="display: flex; gap: 10px; margin-bottom: 10px; padding: 8px;">
                            <img src="${data.user.profilePicture}" class="mini-avatar">
                            <div class="comment-content" style="flex: 1;">
                                <div class="comment-bubble" style="background: #f0f2f5; padding: 8px 12px; border-radius: 18px;">
                                    <strong>${data.user.firstname} ${data.user.lastname}</strong>
                                    <p style="margin: 0;">${data.content}</p>
                                </div>
                                <div class="comment-meta" style="font-size: 12px; color: #65676B; margin-top: 4px;">
                                    <span>V·ª´a xong</span>
                                </div>
                            </div>
                        </div>
                    `;

                    // N·∫øu c√≥ √≠t h∆°n 3 comment, th√™m v√†o initial-comments
                    if (initialComments.children.length < 3) {
                        initialComments.insertAdjacentHTML('afterbegin', newCommentHtml);
                    } else {
                        // N·∫øu ƒë√£ c√≥ 3 comment tr·ªü l√™n, th√™m v√†o hidden-comments
                        hiddenComments.insertAdjacentHTML('afterbegin', newCommentHtml);
                        
                        // Hi·ªÉn th·ªã n√∫t "Xem th√™m" n·∫øu ch∆∞a c√≥
                        const viewMoreBtn = commentsList.querySelector('.view-more-btn');
                        if (viewMoreBtn) {
                            viewMoreBtn.style.display = 'block';
                        }
                    }
                }

                // X√≥a n·ªôi dung input
                input.value = '';
                
                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                showNotification('ƒê√£ th√™m b√¨nh lu·∫≠n th√†nh c√¥ng!');
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('C√≥ l·ªói x·∫£y ra khi th√™m b√¨nh lu·∫≠n', 'error');
            });
        });
    });

    // X·ª≠ l√Ω n√∫t chia s·∫ª
    document.querySelectorAll('.share-btn').forEach(button => {
        button.addEventListener('click', function() {
            currentPostIdForShare = this.getAttribute('data-post-id');
            document.getElementById('shareDialog').style.display = 'flex';
        });
    });

    // X·ª≠ l√Ω n√∫t x√°c nh·∫≠n chia s·∫ª
    document.querySelector('.confirm-share').addEventListener('click', function() {
        if (!currentPostIdForShare) return;

        fetch(`/posts/${currentPostIdForShare}/share`, {
            method: 'POST',
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£t chia s·∫ª
            const shareCountElement = document.querySelector(`.share-count[data-post-id="${currentPostIdForShare}"]`);
            if (shareCountElement) {
                shareCountElement.textContent = `üîÅ ${data.shareCount}`;
            }

            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            showNotification('ƒê√£ chia s·∫ª b√†i vi·∫øt th√†nh c√¥ng!');
            
            // ƒê√≥ng modal
            document.getElementById('shareDialog').style.display = 'none';
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('C√≥ l·ªói x·∫£y ra khi chia s·∫ª b√†i vi·∫øt!', 'error');
        });
    });

    // Th√™m CSS cho animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);

    // X·ª≠ l√Ω n√∫t x√≥a b√¨nh lu·∫≠n
    document.querySelectorAll('.delete-comment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?')) return;
            const commentId = this.getAttribute('data-comment-id');
            fetch(`/posts/comment/${commentId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // X√≥a comment kh·ªèi DOM
                    this.closest('.comment-item').remove();
                    showNotification('ƒê√£ x√≥a b√¨nh lu·∫≠n!');
                } else {
                    showNotification(data.error || 'Kh√¥ng th·ªÉ x√≥a b√¨nh lu·∫≠n!', 'error');
                }
            })
            .catch(() => showNotification('C√≥ l·ªói x·∫£y ra khi x√≥a b√¨nh lu·∫≠n!', 'error'));
        });
    });
	
	document.querySelectorAll('.add-friend-btn').forEach(button => {
	    button.addEventListener('click', () => {
	        const receiverId = button.getAttribute('data-user-id');

	        fetch(`friends/send-friend-request/${receiverId}`, {
	            method: 'POST',
	        })
	        .then(response => {
	            if (response.ok) {
	                button.style.display = 'none';
	                button.nextElementSibling.style.display = 'inline'; // hi·ªán "ƒê√£ g·ª≠i l·ªùi m·ªùi"
	            } else {
	                alert("G·ª≠i l·ªùi m·ªùi th·∫•t b·∫°i!");
	            }
	        })
	        .catch(error => {
	            console.error("Error:", error);
	        });
	    });
	});
});
</script>